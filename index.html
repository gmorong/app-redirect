<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Redirecting to app...</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем элементы для отображения отладочной информации
            const debugInfo = document.getElementById('debug-info');
            const errorMessage = document.getElementById('error-message');
            
            try {
                // Получаем параметры из URL
                const params = new URLSearchParams(window.location.search);
                let token = params.get('token');
                let email = params.get('email');
                let type = params.get('type') || 'recovery';
                
                debugInfo.innerHTML += `<div>Original Parameters:</div>`;
                debugInfo.innerHTML += `<div>- Token: ${token ? (token.length > 10 ? token.substring(0, 10) + '...' : token) : 'null'}</div>`;
                debugInfo.innerHTML += `<div>- Email: ${email || 'null'}</div>`;
                debugInfo.innerHTML += `<div>- Type: ${type}</div>`;
                
                // Проверяем наличие обязательных параметров
                if (!token) {
                    errorMessage.textContent = "Error: Missing token parameter";
                    errorMessage.style.display = 'block';
                    throw new Error("Missing token parameter");
                }
                
                // Если email отсутствует, пытаемся извлечь его из токена
                if (!email && token.includes('.')) {
                    try {
                        debugInfo.innerHTML += `<div>Attempting to extract email from token...</div>`;
                        
                        // Разбиваем JWT на части
                        const parts = token.split('.');
                        if (parts.length >= 2) {
                            // Декодируем payload часть
                            let payload = parts[1];
                            // Заменяем специальные символы для корректного base64
                            payload = payload.replace(/-/g, '+').replace(/_/g, '/');
                            // Добавляем отступ если необходимо
                            while (payload.length % 4) {
                                payload += '=';
                            }
                            
                            // Декодируем base64
                            const decodedPayload = atob(payload);
                            const jsonData = JSON.parse(decodedPayload);
                            
                            debugInfo.innerHTML += `<div>Token payload: ${JSON.stringify(jsonData)}</div>`;
                            
                            // Ищем email в различных полях токена
                            email = jsonData.email || jsonData.sub || jsonData.user?.email;
                            
                            if (email) {
                                debugInfo.innerHTML += `<div style="color:green">Successfully extracted email: ${email}</div>`;
                                // Добавляем email к параметрам
                                params.set('email', email);
                            } else {
                                debugInfo.innerHTML += `<div style="color:orange">Could not find email in token payload</div>`;
                            }
                        }
                    } catch (e) {
                        debugInfo.innerHTML += `<div style="color:red">Error extracting email: ${e.message}</div>`;
                    }
                }
                
                // Если email всё еще отсутствует, выводим предупреждение
                if (!email) {
                    debugInfo.innerHTML += `<div style="color:orange">Warning: No email found in parameters or token!</div>`;
                }
                
                // Убедимся, что type установлен
                if (!params.has('type')) {
                    params.set('type', 'recovery');
                }
                
                // Создаем URL для приложения
                let appUrl = 'io.supabase.pointo://reset-callback/';
                if (params.toString()) {
                    appUrl += '?' + params.toString();
                }
                
                // Отображаем финальный URL
                debugInfo.innerHTML += `<div>Final app URL: ${appUrl}</div>`;
                
                // Обновляем ссылку
                const appLink = document.getElementById('app-link');
                appLink.href = appUrl;
                appLink.style.display = 'inline-block';
                
                // Сохраняем параметры в localStorage для отладки
                localStorage.setItem('reset_token', token);
                if (email) localStorage.setItem('reset_email', email);
                
                // Запускаем обратный отсчет
                const countdown = document.getElementById('countdown');
                let seconds = 5; // Увеличиваем время для отладки
                
                const timer = setInterval(function() {
                    seconds--;
                    countdown.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(timer);
                        // Перенаправляем на приложение
                        window.location.href = appUrl;
                    }
                }, 1000);
                
            } catch (e) {
                console.error("Error:", e);
                debugInfo.innerHTML += `<div style="color:red">Error: ${e.message}</div>`;
                document.getElementById('countdown-container').style.display = 'none';
            }
        });
    </script>
    <style>
        /* ... стили без изменений ... */
        
        #debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        #error-message {
            display: none;
            color: red;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Redirecting to app...</h1>
        <div class="spinner"></div>
        <div id="countdown-container">
            <p>You will be redirected in <span id="countdown">5</span> seconds.</p>
        </div>
        <p>If you are not redirected automatically, please click the button below:</p>
        <a id="app-link" href="#" class="app-button" style="display:none;">Open App</a>
        
        <div id="error-message"></div>
        <div id="debug-info">
            <strong>Debug Information:</strong><br>
        </div>
    </div>
</body>
</html>
